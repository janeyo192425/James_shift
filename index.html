<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>排班管理系統</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        html, body { overscroll-behavior-y: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 圖示組件 ---
        const Icon = ({ path, className, size = 20, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick} style={{cursor: onClick ? 'pointer' : 'default'}}>{path}</svg>
        );
        const Icons = {
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></>} />,
            Edit2: (p) => <Icon {...p} path={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></>} />,
            Briefcase: (p) => <Icon {...p} path={<><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></>} />,
            Coffee: (p) => <Icon {...p} path={<><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></>} />,
            ChevronLeft: (p) => <Icon {...p} path={<polyline points="15 18 9 12 15 6"></polyline>} />,
            ChevronRight: (p) => <Icon {...p} path={<polyline points="9 18 15 12 9 6"></polyline>} />,
            RotateCcw: (p) => <Icon {...p} path={<><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></>} />,
            Refresh: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>} />
        };

        // ▼▼▼ 最新資料設定區 (V10) ▼▼▼
        const DEFAULT_DATA = [
            { id: 1, name: '葉貞成', startDateStr: '2026-01-18', role: 'eng', dept: '防銲無塵室' },
            { id: 2, name: '林健業', startDateStr: '2026-01-19', role: 'eng', dept: '防銲外場' },
            { id: 3, name: '凌賜恩', startDateStr: '2026-01-21', role: 'eng', dept: '表面處理' },
            { id: 4, name: '黃志丰', startDateStr: '2026-01-21', role: 'eng', dept: '量測車間' },
            { id: 5, name: '陳信男', startDateStr: '2026-01-19', role: 'op', dept: '防銲無塵室' },
            { id: 6, name: '蔡逸凡', startDateStr: '2026-01-18', role: 'op', dept: '防銲無塵室' },
            { id: 7, name: '邱正偉', startDateStr: '2026-01-19', role: 'op', dept: '防銲外場' },
            { id: 8, name: '蔡宗翰', startDateStr: '2026-01-20', role: 'op', dept: '表面處理' },
            { id: 9, name: '陳婕妮', startDateStr: '2026-01-18', role: 'op', dept: '量測車間' },
        ];
        // ▲▲▲ 最新資料設定區 ▲▲▲

        const EngineerShiftTracker = () => {
            // ★★★ 關鍵：Storage Key 改為 v10，強制讀取新資料 ★★★
            const [engineers, setEngineers] = React.useState(() => {
                const saved = localStorage.getItem('shift_data_v10');
                if (saved) {
                    try { return JSON.parse(saved); } catch (e) { console.error(e); }
                }
                return DEFAULT_DATA;
            });

            const [isEditing, setIsEditing] = React.useState(null);
            const [viewDate, setViewDate] = React.useState(new Date());
            const [filterRole, setFilterRole] = React.useState('eng'); 
            const [deleteConfirmId, setDeleteConfirmId] = React.useState(null);
            const [editForm, setEditForm] = React.useState({ name: '', role: 'eng', dept: '', year: 2026, month: 1, day: 1 });

            React.useEffect(() => {
                localStorage.setItem('shift_data_v10', JSON.stringify(engineers));
            }, [engineers]);

            // --- 強制重置功能 ---
            const handleForceReset = () => {
                if(confirm('確定要強制載入「葉貞成、林健業...」這份最新名單嗎？\n(目前的修改將會被覆蓋)')) {
                    setEngineers(DEFAULT_DATA);
                    localStorage.setItem('shift_data_v10', JSON.stringify(DEFAULT_DATA));
                    alert('已更新為最新名單！');
                }
            };

            const parseDateString = (dateStr) => {
                if (!dateStr) return null;
                const [y, m, d] = dateStr.split('-').map(Number);
                return new Date(y, m - 1, d);
            };

            const getShiftStatus = (baseDateStr, targetDate) => {
                if (!baseDateStr) return null;
                const start = parseDateString(baseDateStr);
                const target = new Date(targetDate);
                target.setHours(0, 0, 0, 0); 
                const diffTime = target.getTime() - start.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const cycleDay = ((diffDays % 6) + 6) % 6;
                return cycleDay < 4 
                    ? { type: 'work', day: cycleDay + 1, label: `上班 D${cycleDay + 1}` }
                    : { type: 'off', day: cycleDay - 3, label: `休假 D${cycleDay - 3}` };
            };

            const today = new Date();
            const currentYear = today.getFullYear();

            const handleAdd = () => {
                const newId = Date.now();
                const newEng = { id: newId, name: '新人員', startDateStr: '', role: filterRole === 'all' ? 'eng' : filterRole, dept: '一課' };
                setEngineers([...engineers, newEng]);
                startEdit(newEng);
            };

            const startEdit = (eng) => {
                setIsEditing(eng.id);
                setDeleteConfirmId(null);
                const date = eng.startDateStr ? parseDateString(eng.startDateStr) : new Date();
                setEditForm({
                    name: eng.name,
                    role: eng.role || 'eng',
                    dept: eng.dept || '一課',
                    year: date.getFullYear(),
                    month: date.getMonth() + 1,
                    day: date.getDate()
                });
            };

            const saveEdit = (id) => {
                const { year, month, day, name, role, dept } = editForm;
                const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                setEngineers(engineers.map(e => e.id === id ? { ...e, name, role, dept, startDateStr: dateStr } : e));
                setIsEditing(null);
            };

            const deleteEng = (id) => {
                setEngineers(engineers.filter(e => e.id !== id));
                setIsEditing(null);
            };

            const filteredData = engineers.filter(e => filterRole === 'all' || (e.role || 'eng') === filterRole);
            const departments = [...new Set(filteredData.map(e => e.dept || '未分類'))].sort();

            const getCurrentWeekDays = () => {
                const start = new Date(viewDate);
                const day = start.getDay(); 
                start.setDate(start.getDate() - day);
                return Array.from({length: 7}, (_, i) => {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    return d;
                });
            };
            const weekDays = getCurrentWeekDays();
            const weekRangeStr = `${weekDays[0].getMonth()+1}/${weekDays[0].getDate()} ~ ${weekDays[6].getMonth()+1}/${weekDays[6].getDate()}`;
            const isToday = (d) => d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
            
            const years = [currentYear - 1, currentYear, currentYear + 1];
            const months = Array.from({length: 12}, (_, i) => i + 1);
            const daysInMonth = new Date(editForm.year, editForm.month, 0).getDate();
            const days = Array.from({length: daysInMonth}, (_, i) => i + 1);

            return (
                <div className="min-h-screen pb-24 max-w-md mx-auto">
                    <div className="bg-white p-4 shadow-sm sticky top-0 z-30 border-b border-slate-100">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-lg font-bold flex items-center gap-2 text-slate-800">
                                <Icons.Users className="text-blue-600" /> 排班管理 <span className="text-xs text-slate-400 font-normal">(最新版)</span>
                            </h1>
                            <div className="flex gap-2">
                                {/* ★★★ 強制重置按鈕 ★★★ */}
                                <button onClick={handleForceReset} className="text-xs flex items-center gap-1 bg-red-50 px-2 py-1 rounded-md text-red-600 border border-red-200 hover:bg-red-100 active:scale-95 transition-transform" title="如果名單沒更新請點我">
                                    <Icons.Refresh size={12}/> 重置名單
                                </button>
                                <button onClick={() => setViewDate(new Date())} className="text-xs flex items-center gap-1 bg-slate-100 px-3 py-1.5 rounded-full text-slate-600 font-medium active:scale-95 transition-transform"><Icons.RotateCcw size={12}/> 回今天</button>
                            </div>
                        </div>

                        <div className="flex p-1 bg-slate-100 rounded-xl mb-3">
                            {[
                                { id: 'eng', label: '工程師' },
                                { id: 'op', label: '員級' },
                                { id: 'all', label: '全部' }
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setFilterRole(tab.id)}
                                    className={`flex-1 py-1.5 text-sm font-bold rounded-lg transition-all ${filterRole === tab.id ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        <div className="flex items-center justify-between bg-slate-50 rounded-xl p-1 select-none border border-slate-200">
                            <button onClick={() => {const d=new Date(viewDate);d.setDate(d.getDate()-7);setViewDate(d)}} className="p-2 hover:bg-white rounded-lg text-slate-500 hover:text-blue-600"><Icons.ChevronLeft /></button>
                            <div className="text-sm font-bold text-slate-700 font-mono">{weekRangeStr}</div>
                            <button onClick={() => {const d=new Date(viewDate);d.setDate(d.getDate()+7);setViewDate(d)}} className="p-2 hover:bg-white rounded-lg text-slate-500 hover:text-blue-600"><Icons.ChevronRight /></button>
                        </div>
                    </div>

                    <div className="p-4 space-y-6">
                        {departments.map(dept => (
                            <div key={dept}>
                                <div className="flex items-center gap-2 mb-3 px-1">
                                    <div className="h-4 w-1 bg-blue-500 rounded-full"></div>
                                    <h3 className="font-bold text-slate-700">{dept}</h3>
                                </div>

                                <div className="space-y-3">
                                    {filteredData.filter(e => (e.dept || '未分類') === dept).map(eng => {
                                        const todayStatus = getShiftStatus(eng.startDateStr, today);
                                        const isTodayWork = todayStatus?.type === 'work';

                                        if (isEditing === eng.id) {
                                            return (
                                                <div key={eng.id} className="bg-white p-5 rounded-2xl shadow-xl border-2 border-blue-500 animate-in relative z-20">
                                                    <div className="flex justify-between items-center mb-4">
                                                        <h3 className="font-bold text-blue-600 flex items-center gap-2"><Icons.Edit2 size={16}/> 編輯資料</h3>
                                                        {deleteConfirmId === eng.id ? (
                                                            <div className="flex gap-2">
                                                                <button onClick={() => deleteEng(eng.id)} className="bg-red-500 text-white text-xs px-2 py-1 rounded">確認</button>
                                                                <button onClick={() => setDeleteConfirmId(null)} className="bg-slate-100 text-xs px-2 py-1 rounded">取消</button>
                                                            </div>
                                                        ) : <button onClick={() => setDeleteConfirmId(eng.id)} className="text-red-300 hover:text-red-500"><Icons.Trash2 size={18}/></button>}
                                                    </div>
                                                    <div className="space-y-3">
                                                        <div className="flex gap-2">
                                                            <div className="flex-1">
                                                                <label className="text-xs font-bold text-slate-400 block mb-1">姓名</label>
                                                                <input type="text" value={editForm.name} onChange={e=>setEditForm({...editForm, name: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50"/>
                                                            </div>
                                                            <div className="w-1/3">
                                                                <label className="text-xs font-bold text-slate-400 block mb-1">職位</label>
                                                                <select value={editForm.role} onChange={e=>setEditForm({...editForm, role: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50">
                                                                    <option value="eng">工程師</option>
                                                                    <option value="op">員級</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-slate-400 block mb-1">部門/課別</label>
                                                            <input type="text" value={editForm.dept} onChange={e=>setEditForm({...editForm, dept: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" placeholder="例如: 一課"/>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-slate-400 block mb-1">最近一次「上班第一天」</label>
                                                            <div className="flex gap-1">
                                                                <select value={editForm.year} onChange={e=>setEditForm({...editForm, year:Number(e.target.value)})} className="flex-1 p-2 border rounded-lg bg-slate-50 text-center">{years.map(y=><option key={y} value={y}>{y}</option>)}</select>
                                                                <select value={editForm.month} onChange={e=>setEditForm({...editForm, month:Number(e.target.value)})} className="flex-1 p-2 border rounded-lg bg-slate-50 text-center">{months.map(m=><option key={m} value={m}>{m}月</option>)}</select>
                                                                <select value={editForm.day} onChange={e=>setEditForm({...editForm, day:Number(e.target.value)})} className="flex-1 p-2 border rounded-lg bg-slate-50 text-center">{days.map(d=><option key={d} value={d}>{d}日</option>)}</select>
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2 pt-2">
                                                            <button onClick={() => saveEdit(eng.id)} className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">儲存</button>
                                                            <button onClick={() => setIsEditing(null)} className="flex-1 bg-slate-100 text-slate-500 py-2 rounded-lg font-bold">取消</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        }

                                        return (
                                            <div key={eng.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                                                <div className="p-3 flex items-center justify-between relative z-10">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white text-sm ${eng.role === 'eng' ? 'bg-blue-400' : 'bg-slate-400'}`}>
                                                            {eng.name[0]}
                                                        </div>
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-slate-800">{eng.name}</span>
                                                                <button onClick={() => startEdit(eng)} className="text-slate-300 hover:text-blue-500"><Icons.Edit2 size={14}/></button>
                                                            </div>
                                                            <div className="flex items-center gap-2 mt-0.5">
                                                                {eng.role === 'op' && <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded">員級</span>}
                                                                {eng.startDateStr ? (
                                                                    <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded ${isTodayWork ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700'}`}>
                                                                        {todayStatus.label}
                                                                    </span>
                                                                ) : <span className="text-[10px] text-slate-300">未設定</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {eng.startDateStr && (
                                                        <div className={`flex flex-col items-center px-3 py-1 rounded-lg ${isTodayWork ? 'bg-emerald-50' : 'bg-orange-50'}`}>
                                                            <span className={`text-xl font-black ${isTodayWork ? 'text-emerald-500' : 'text-orange-400'}`}>{todayStatus.day}</span>
                                                            <span className={`text-[9px] font-bold ${isTodayWork ? 'text-emerald-600' : 'text-orange-500'}`}>{isTodayWork ? '上班' : '休假'}</span>
                                                        </div>
                                                    )}
                                                </div>

                                                {eng.startDateStr && (
                                                    <div className="bg-slate-50/50 px-2 py-2 border-t border-slate-100">
                                                        <div className="grid grid-cols-7 gap-1">
                                                            {weekDays.map((d, i) => {
                                                                const st = getShiftStatus(eng.startDateStr, d);
                                                                const iw = st?.type === 'work';
                                                                const it = isToday(d);
                                                                return (
                                                                    <div key={i} className={`flex flex-col items-center gap-1 p-1 rounded-lg ${it ? 'bg-white shadow-sm ring-1 ring-blue-100' : ''}`}>
                                                                        <span className={`text-[9px] font-mono ${it ? 'text-blue-600 font-bold' : 'text-slate-400'}`}>{d.getMonth()+1}/{d.getDate()}</span>
                                                                        <div className={`w-full h-1.5 rounded-full ${iw ? 'bg-emerald-400' : 'bg-orange-300'}`}></div>
                                                                    </div>
                                                                )
                                                            })}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>

                    <button onClick={handleAdd} className="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg shadow-blue-600/30 flex items-center justify-center hover:bg-blue-700 hover:scale-105 transition-all active:scale-95 z-40">
                        <Icons.Plus size={28} />
                    </button>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EngineerShiftTracker />);
    </script>
</body>
</html>
